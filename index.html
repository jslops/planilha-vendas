<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Digital de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block; }
            .print-full-width { width: 100% !important; }
            body { font-size: 12px; }
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .highlight-goal-met {
            background-color: #d4edda;
        }
        .highlight-goal-not-met {
            background-color: #f8d7da;
        }
        .return-row {
            background-color: #fff3cd !important;
        }
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        .sync-saving {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .sync-saved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .sync-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* Melhorias para mobile */
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column !important;
            }
            .mobile-full-width {
                width: 100% !important;
            }
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
            .mobile-grid-cols-1 {
                grid-template-columns: 1fr !important;
            }
            .mobile-grid-cols-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .mobile-hidden {
                display: none !important;
            }
            .mobile-show {
                display: block !important;
            }
            .table-container {
                max-height: 400px;
                font-size: 0.75rem;
            }
            .mobile-btn-sm {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.75rem !important;
            }
        }
        /* Scroll personalizado para tabelas */
        .table-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-4">
    <!-- Status de sincroniza√ß√£o -->
    <div id="sync-status" class="sync-status" style="display: none;">
        Salvando...
    </div>

    <div class="container mx-auto bg-white rounded-lg shadow-md p-4 md:p-6">
        <header class="mb-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-2 md:space-y-0">
                <div class="text-center md:text-left">
                    <h1 class="text-xl md:text-3xl font-bold text-blue-700">Planilha de Vendas</h1>
                    <p class="text-green-600 text-sm md:text-base mt-1 md:mt-2">‚úì Dados salvos localmente</p>
                </div>
                <div class="flex flex-wrap justify-center gap-2 mobile-btn-sm">
                    <button id="import-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 md:px-4 md:py-2 rounded no-print text-sm">
                        üì• Importar
                    </button>
                    <button id="backup-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 md:px-4 md:py-2 rounded no-print text-sm">
                        üíæ Exportar
                    </button>
                    <button id="print-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 md:px-4 md:py-2 rounded no-print text-sm">
                        üñ®Ô∏è Imprimir
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mt-4 space-y-2 md:space-y-0 no-print">
                <div class="flex items-center justify-center md:justify-start">
                    <label for="year-select" class="mr-2 text-sm md:text-base">Ano:</label>
                    <select id="year-select" class="border rounded p-1 text-sm md:text-base">
                        <!-- Op√ß√µes de ano ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                <div class="flex flex-wrap justify-center gap-2">
                    <button id="refresh-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 md:px-4 md:py-2 rounded text-sm">
                        üîÑ Atualizar
                    </button>
                    <button id="clear-data-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 md:px-4 md:py-2 rounded text-sm">
                        üóëÔ∏è Limpar Dados
                    </button>
                </div>
            </div>
        </header>

        <!-- Navega√ß√£o por meses - Vers√£o Mobile Compacta -->
        <div class="mb-4 no-print">
            <div class="md:hidden mb-2">
                <select id="mobile-month-select" class="w-full border rounded p-2 text-sm">
                    <option value="0">Janeiro</option>
                    <option value="1">Fevereiro</option>
                    <option value="2">Mar√ßo</option>
                    <option value="3">Abril</option>
                    <option value="4">Maio</option>
                    <option value="5">Junho</option>
                    <option value="6">Julho</option>
                    <option value="7">Agosto</option>
                    <option value="8">Setembro</option>
                    <option value="9">Outubro</option>
                    <option value="10">Novembro</option>
                    <option value="11">Dezembro</option>
                </select>
            </div>
            <div class="hidden md:flex flex-wrap justify-center gap-2">
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="0">Jan</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="1">Fev</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="2">Mar</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="3">Abr</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="4">Mai</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="5">Jun</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="6">Jul</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="7">Ago</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="8">Set</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="9">Out</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="10">Nov</button>
                <button class="month-tab px-3 py-1 md:px-4 md:py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm" data-month="11">Dez</button>
            </div>
        </div>

        <!-- Configura√ß√£o de meta mensal -->
        <div class="mb-4 md:mb-6 p-3 md:p-4 bg-blue-50 rounded-lg no-print">
            <h2 class="text-lg md:text-xl font-semibold mb-2">Meta Mensal</h2>
            <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
                <div class="flex-1">
                    <label for="monthly-goal" class="block text-sm font-medium">Meta do M√™s (R$):</label>
                    <input type="number" id="monthly-goal" class="border rounded p-2 w-full text-sm md:text-base" min="0" step="0.01">
                </div>
                <div class="flex-1">
                    <label for="workdays" class="block text-sm font-medium">Dias √öteis:</label>
                    <input type="number" id="workdays" class="border rounded p-2 w-full text-sm md:text-base" min="1" max="31">
                </div>
                <div class="flex-1">
                    <button id="save-goal-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full md:w-auto mt-2 md:mt-5 text-sm md:text-base">Salvar Meta</button>
                </div>
            </div>
        </div>

        <!-- Resumo mensal ATUALIZADO com layout responsivo -->
        <div class="mb-4 md:mb-6 p-3 md:p-4 bg-green-50 rounded-lg">
            <h2 class="text-lg md:text-xl font-semibold mb-2">Resumo do M√™s</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 md:gap-4">
                <div class="bg-white p-2 md:p-4 rounded shadow">
                    <h3 class="font-medium text-xs md:text-sm">Total Vendido</h3>
                    <p id="total-sold" class="text-lg md:text-2xl font-bold text-green-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-2 md:p-4 rounded shadow">
                    <h3 class="font-medium text-xs md:text-sm">Devolu√ß√µes</h3>
                    <p id="total-returns" class="text-lg md:text-2xl font-bold text-red-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-2 md:p-4 rounded shadow">
                    <h3 class="font-medium text-xs md:text-sm">L√≠quido</h3>
                    <p id="net-amount" class="text-lg md:text-2xl font-bold text-blue-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-2 md:p-4 rounded shadow">
                    <h3 class="font-medium text-xs md:text-sm">Meta Mensal</h3>
                    <p id="monthly-goal-display" class="text-lg md:text-2xl font-bold text-purple-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-2 md:p-4 rounded shadow">
                    <h3 class="font-medium text-xs md:text-sm">Meta Di√°ria</h3>
                    <p id="daily-goal" class="text-lg md:text-2xl font-bold text-orange-600">R$ 0,00</p>
                </div>
                <div class="bg-white p-2 md:p-4 rounded shadow">
                    <h3 class="font-medium text-xs md:text-sm">M√©dia Necess√°ria</h3>
                    <p id="average-needed" class="text-lg md:text-2xl font-bold text-indigo-600">R$ 0,00</p>
                    <p class="text-xs text-gray-500 mt-1 hidden md:block">por dia para bater a meta</p>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de progresso -->
        <div class="mb-4 md:mb-6 no-print">
            <canvas id="sales-chart" height="80"></canvas>
        </div>

        <!-- Formul√°rio para adicionar venda - Vers√£o Responsiva -->
        <div class="mb-4 md:mb-6 p-3 md:p-4 bg-gray-50 rounded-lg no-print">
            <h2 class="text-lg md:text-xl font-semibold mb-2">Adicionar Venda</h2>
            <form id="sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-2 md:gap-4">
                <div class="md:col-span-1">
                    <label for="sale-date" class="block text-sm font-medium">Data:</label>
                    <input type="date" id="sale-date" class="border rounded p-2 w-full text-sm" required>
                </div>
                <div class="md:col-span-1">
                    <label for="sale-code" class="block text-sm font-medium">C√≥digo:</label>
                    <input type="text" id="sale-code" class="border rounded p-2 w-full text-sm" required>
                </div>
                <div class="md:col-span-1">
                    <label for="sale-value" class="block text-sm font-medium">Valor (R$):</label>
                    <input type="number" id="sale-value" class="border rounded p-2 w-full text-sm" min="0" step="0.01" required>
                </div>
                <div class="md:col-span-1">
                    <label for="sale-type" class="block text-sm font-medium">Tipo:</label>
                    <select id="sale-type" class="border rounded p-2 w-full text-sm">
                        <option value="sale">Venda</option>
                        <option value="return">Devolu√ß√£o</option>
                    </select>
                </div>
                <div class="md:col-span-2 lg:col-span-1">
                    <label for="sale-description" class="block text-sm font-medium">Descri√ß√£o:</label>
                    <input type="text" id="sale-description" class="border rounded p-2 w-full text-sm">
                </div>
                <div class="md:col-span-2 lg:col-span-1 flex items-end">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full text-sm">Adicionar</button>
                </div>
            </form>
        </div>

        <!-- Tabela de vendas com scroll responsivo -->
        <div class="mb-4 md:mb-6">
            <h2 class="text-lg md:text-xl font-semibold mb-2">Vendas do M√™s</h2>
            <div class="table-container border rounded">
                <table id="sales-table" class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                            <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                            <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider mobile-hidden">Descri√ß√£o</th>
                            <th class="px-2 md:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- As vendas ser√£o preenchidas via JavaScript -->
                    </tbody>
                    <tfoot class="bg-gray-50 font-semibold">
                        <tr>
                            <td class="px-2 md:px-4 py-2" colspan="2">Total Di√°rio:</td>
                            <td id="daily-total" class="px-2 md:px-4 py-2">R$ 0,00</td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Anota√ß√µes do m√™s -->
        <div class="mb-4 md:mb-6 no-print">
            <h2 class="text-lg md:text-xl font-semibold mb-2">Anota√ß√µes do M√™s</h2>
            <textarea id="month-notes" class="w-full border rounded p-2 h-24 md:h-32 text-sm" placeholder="Adicione suas anota√ß√µes aqui..."></textarea>
            <button id="save-notes-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2 text-sm">Salvar Anota√ß√µes</button>
        </div>

        <!-- Relat√≥rio para impress√£o -->
        <div id="print-report" class="print-only">
            <h2 class="text-2xl font-bold text-center mb-4">Relat√≥rio de Vendas</h2>
            <div class="mb-4">
                <p><strong>M√™s:</strong> <span id="print-month"></span></p>
                <p><strong>Ano:</strong> <span id="print-year"></span></p>
            </div>
            <div class="mb-4 grid grid-cols-2 gap-4">
                <div>
                    <p><strong>Total Vendido:</strong> <span id="print-total-sold"></span></p>
                    <p><strong>Total Devolu√ß√µes:</strong> <span id="print-total-returns"></span></p>
                    <p><strong>L√≠quido:</strong> <span id="print-net-amount"></span></p>
                </div>
                <div>
                    <p><strong>Meta Mensal:</strong> <span id="print-monthly-goal"></span></p>
                    <p><strong>Diferen√ßa:</strong> <span id="print-difference"></span></p>
                    <p><strong>Meta Di√°ria:</strong> <span id="print-daily-goal"></span></p>
                    <p><strong>M√©dia Necess√°ria:</strong> <span id="print-average-needed"></span></p>
                </div>
            </div>
            <table id="print-sales-table" class="print-full-width min-w-full border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border px-4 py-2 text-left">Data</th>
                        <th class="border px-4 py-2 text-left">C√≥digo</th>
                        <th class="border px-4 py-2 text-left">Valor (R$)</th>
                        <th class="border px-4 py-2 text-left">Tipo</th>
                        <th class="border px-4 py-2 text-left">Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Conte√∫do ser√° preenchido via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Importar Dados -->
    <div id="import-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-gray-900">Importar Dados</h3>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-3">Selecione o arquivo de backup (.json) para importar</p>
                    <input type="file" id="import-file" class="w-full border rounded p-2 text-sm" accept=".json">
                </div>
                <div class="mt-4 text-left text-sm text-gray-600">
                    <p class="font-semibold">Aten√ß√£o:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li>Os dados atuais ser√£o substitu√≠dos</li>
                        <li>Formato esperado: Exporta√ß√£o desta planilha</li>
                        <li>Fa√ßa backup antes de importar</li>
                    </ul>
                </div>
                <div id="import-message" class="mt-2 text-sm"></div>
                <div class="flex justify-center mt-4 space-x-2">
                    <button id="confirm-import" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">Importar</button>
                    <button id="cancel-import" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let salesData = {};
        let monthlyGoals = {};
        let monthNotes = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando planilha de vendas...');
            console.log('Dispositivo:', isMobile() ? 'Mobile' : 'Desktop');
            initializeApp();
            setupEventListeners();
            loadData();
            updateDisplay();
        });

        // ========== DETEC√á√ÉO DE DISPOSITIVO ==========
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // ========== FUN√á√ïES PRINCIPAIS ==========

        function initializeApp() {
            console.log('Inicializando aplica√ß√£o...');
            
            // Preencher anos
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            setCurrentDate();
            updateMonthTabs();
        }

        function setupEventListeners() {
            console.log('Configurando event listeners...');
            
            // Navega√ß√£o por meses
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    currentMonth = parseInt(this.getAttribute('data-month'));
                    updateMonthTabs();
                    updateDisplay();
                });
            });

            // Navega√ß√£o mobile
            document.getElementById('mobile-month-select').addEventListener('change', function() {
                currentMonth = parseInt(this.value);
                updateMonthTabs();
                updateDisplay();
            });

            // Alterar ano
            document.getElementById('year-select').addEventListener('change', function() {
                currentYear = parseInt(this.value);
                updateDisplay();
            });

            // Formul√°rio de venda
            document.getElementById('sale-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addSale();
            });

            // Salvar meta
            document.getElementById('save-goal-btn').addEventListener('click', saveMonthlyGoal);

            // Salvar anota√ß√µes
            document.getElementById('save-notes-btn').addEventListener('click', saveMonthNotes);

            // Bot√µes de a√ß√£o
            document.getElementById('refresh-btn').addEventListener('click', function() {
                loadData();
                updateDisplay();
                showSyncStatus('Dados recarregados!', 'saved');
            });
            
            document.getElementById('backup-btn').addEventListener('click', exportData);
            document.getElementById('print-btn').addEventListener('click', printReport);
            
            // Novo bot√£o para limpar dados (√∫til para debug)
            document.getElementById('clear-data-btn').addEventListener('click', function() {
                if (confirm('‚ö†Ô∏è TEM CERTEZA que deseja limpar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!')) {
                    clearAllData();
                }
            });

            // Importar dados
            document.getElementById('import-btn').addEventListener('click', showImportModal);
            document.getElementById('confirm-import').addEventListener('click', importData);
            document.getElementById('cancel-import').addEventListener('click', hideImportModal);

            // Debug: log quando a p√°gina √© fechada/recarregada
            window.addEventListener('beforeunload', function() {
                console.log('P√°gina est√° sendo fechada/recarregada. Dados atuais:');
                console.log('salesData:', salesData);
                console.log('monthlyGoals:', monthlyGoals);
                console.log('monthNotes:', monthNotes);
            });
        }

        // ========== FUN√á√ÉO PARA LIMPAR DADOS ==========
        function clearAllData() {
            salesData = {};
            monthlyGoals = {};
            monthNotes = {};
            
            // Reinicializar estrutura vazia
            initializeEmptyData();
            
            // Limpar localStorage
            localStorage.removeItem('salesData');
            localStorage.removeItem('monthlyGoals');
            localStorage.removeItem('monthNotes');
            
            // Atualizar display
            updateDisplay();
            
            showSyncStatus('Todos os dados foram limpos!', 'saved');
            console.log('Dados limpos com sucesso');
        }

        // ========== FUN√á√ÉO DE IMPORTAR DADOS ==========

        function showImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
        }

        function hideImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('import-file').value = '';
            document.getElementById('import-message').textContent = '';
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showImportMessage('Selecione um arquivo para importar.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validar estrutura do arquivo
                    if (!importedData.salesData || !importedData.monthlyGoals || !importedData.monthNotes) {
                        throw new Error('Arquivo inv√°lido: estrutura de dados incorreta.');
                    }
                    
                    if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso substituir√° todos os seus dados atuais. Deseja continuar?')) {
                        // Substituir dados atuais
                        salesData = importedData.salesData;
                        monthlyGoals = importedData.monthlyGoals;
                        monthNotes = importedData.monthNotes;
                        
                        // Salvar dados
                        saveData();
                        showImportMessage('Dados importados com sucesso!', 'success');
                        updateDisplay();
                        setTimeout(() => {
                            hideImportModal();
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    showImportMessage('Erro: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showImportMessage('Erro ao ler o arquivo.', 'error');
            };
            
            reader.readAsText(file);
        }

        function showImportMessage(message, type) {
            const element = document.getElementById('import-message');
            element.textContent = message;
            element.className = `mt-2 text-sm ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        }

        // ========== FUN√á√ïES DE DADOS CORRIGIDAS ==========

        function loadData() {
            console.log('Carregando dados do localStorage...');
            
            try {
                // Carregar dados de vendas
                const savedSales = localStorage.getItem('salesData');
                if (savedSales) {
                    salesData = JSON.parse(savedSales);
                    console.log('Dados de vendas carregados:', Object.keys(salesData).length, 'anos');
                } else {
                    console.log('Nenhum dado de vendas encontrado, inicializando estrutura vazia');
                    initializeEmptyData();
                }

                // Carregar metas mensais
                const savedGoals = localStorage.getItem('monthlyGoals');
                if (savedGoals) {
                    monthlyGoals = JSON.parse(savedGoals);
                    console.log('Metas carregadas:', Object.keys(monthlyGoals).length, 'meses');
                } else {
                    console.log('Nenhuma meta encontrada');
                    monthlyGoals = {};
                }

                // Carregar anota√ß√µes
                const savedNotes = localStorage.getItem('monthNotes');
                if (savedNotes) {
                    monthNotes = JSON.parse(savedNotes);
                    console.log('Anota√ß√µes carregadas:', Object.keys(monthNotes).length, 'meses');
                } else {
                    console.log('Nenhuma anota√ß√£o encontrada');
                    monthNotes = {};
                }
                
                console.log('Dados carregados com sucesso do localStorage');
                console.log('Dispositivo:', isMobile() ? 'Mobile' : 'Desktop');
                
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
                console.log('Inicializando dados vazios devido ao erro');
                initializeEmptyData();
                monthlyGoals = {};
                monthNotes = {};
            }
        }

        function saveData() {
            console.log('Salvando dados no localStorage...');
            console.log('Dispositivo:', isMobile() ? 'Mobile' : 'Desktop');
            
            showSyncStatus('Salvando...', 'saving');
            
            try {
                // Verificar se os dados s√£o v√°lidos antes de salvar
                if (!salesData || typeof salesData !== 'object') {
                    console.error('Dados de vendas inv√°lidos:', salesData);
                    salesData = {};
                }
                if (!monthlyGoals || typeof monthlyGoals !== 'object') {
                    console.error('Metas inv√°lidas:', monthlyGoals);
                    monthlyGoals = {};
                }
                if (!monthNotes || typeof monthNotes !== 'object') {
                    console.error('Anota√ß√µes inv√°lidas:', monthNotes);
                    monthNotes = {};
                }
                
                // Salvar no localStorage
                localStorage.setItem('salesData', JSON.stringify(salesData));
                localStorage.setItem('monthlyGoals', JSON.stringify(monthlyGoals));
                localStorage.setItem('monthNotes', JSON.stringify(monthNotes));
                
                console.log('Dados salvos com sucesso no localStorage');
                console.log('salesData tamanho:', JSON.stringify(salesData).length, 'caracteres');
                console.log('monthlyGoals tamanho:', JSON.stringify(monthlyGoals).length, 'caracteres');
                console.log('monthNotes tamanho:', JSON.stringify(monthNotes).length, 'caracteres');
                
                showSyncStatus('Dados salvos!', 'saved');
                
            } catch (error) {
                console.error('Erro ao salvar dados no localStorage:', error);
                showSyncStatus('Erro ao salvar!', 'error');
                
                // Tentar salvar em sessionStorage como fallback
                try {
                    sessionStorage.setItem('salesData_backup', JSON.stringify(salesData));
                    sessionStorage.setItem('monthlyGoals_backup', JSON.stringify(monthlyGoals));
                    sessionStorage.setItem('monthNotes_backup', JSON.stringify(monthNotes));
                    console.log('Dados salvos no sessionStorage como backup');
                } catch (fallbackError) {
                    console.error('Erro ao salvar no sessionStorage:', fallbackError);
                }
            }
        }

        function initializeEmptyData() {
            salesData = {};
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                salesData[year] = {};
                for (let month = 0; month < 12; month++) {
                    salesData[year][month] = [];
                }
            }
            console.log('Estrutura de dados vazia inicializada');
        }

        // ========== FUN√á√ïES DE INTERFACE ==========

        function showSyncStatus(message, type = 'saving') {
            const statusElement = document.getElementById('sync-status');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'saved') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 2000);
            }
        }

        function setCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('sale-date').value = `${year}-${month}-${day}`;
        }

        function updateMonthTabs() {
            // Atualizar sele√ß√£o mobile
            document.getElementById('mobile-month-select').value = currentMonth;
            
            // Atualizar abas desktop
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.classList.remove('bg-blue-500', 'text-white');
                tab.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            
            const activeTab = document.querySelector(`.month-tab[data-month="${currentMonth}"]`);
            if (activeTab) {
                activeTab.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                activeTab.classList.add('bg-blue-500', 'text-white');
            }
        }

        function updateDisplay() {
            console.log('Atualizando display... M√™s:', currentMonth + 1, 'Ano:', currentYear);
            updateSalesTable();
            updateMonthlySummary();
            updateChart();
            updateMonthNotes();
            updateGoalInputs();
        }

        // ========== FUN√á√ïES DA PLANILHA ==========

        function updateSalesTable() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';

            const monthSales = getCurrentMonthSales();
            let dailyTotal = 0;
            let currentDate = null;

            console.log('Vendas do m√™s atual:', monthSales.length);

            if (monthSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhuma venda cadastrada este m√™s</td></tr>';
                document.getElementById('daily-total').textContent = 'R$ 0,00';
                return;
            }

            monthSales.forEach((sale, index) => {
                const formattedDate = formatStoredDate(sale.date);

                // Se √© um novo dia, adicionar linha de separa√ß√£o
                if (currentDate !== formattedDate) {
                    if (currentDate !== null) {
                        // Adicionar total do dia anterior
                        addDailyTotalRow(tbody, currentDate, dailyTotal);
                        dailyTotal = 0;
                    }
                    currentDate = formattedDate;
                }

                // Determinar classe CSS baseada no tipo
                const rowClass = sale.type === 'return' ? 'return-row' : '';
                
                // Adicionar linha da venda
                const row = document.createElement('tr');
                if (rowClass) row.classList.add(rowClass);
                
                row.innerHTML = `
                    <td class="px-2 md:px-4 py-2">${formattedDate}</td>
                    <td class="px-2 md:px-4 py-2">${sale.code}</td>
                    <td class="px-2 md:px-4 py-2 ${sale.type === 'return' ? 'text-red-600' : ''}">
                        ${sale.type === 'return' ? '-' : ''}R$ ${formatCurrency(sale.value)}
                    </td>
                    <td class="px-2 md:px-4 py-2">${sale.type === 'return' ? 'Devolu√ß√£o' : 'Venda'}</td>
                    <td class="px-2 md:px-4 py-2 mobile-hidden">${sale.description || ''}</td>
                    <td class="px-2 md:px-4 py-2 no-print">
                        <button class="edit-sale text-blue-500 hover:text-blue-700 mr-2 text-xs" data-index="${index}">Editar</button>
                        <button class="delete-sale text-red-500 hover:text-red-700 text-xs" data-index="${index}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Adicionar ao total di√°rio (subtrair se for devolu√ß√£o)
                if (sale.type === 'return') {
                    dailyTotal -= sale.value;
                } else {
                    dailyTotal += sale.value;
                }

                // Configurar eventos para os bot√µes de editar e excluir
                row.querySelector('.edit-sale').addEventListener('click', function() {
                    editSale(index);
                });
                row.querySelector('.delete-sale').addEventListener('click', function() {
                    deleteSale(index);
                });
            });

            // Adicionar total do √∫ltimo dia
            if (currentDate !== null) {
                addDailyTotalRow(tbody, currentDate, dailyTotal);
            }

            // Atualizar total di√°rio no rodap√©
            document.getElementById('daily-total').textContent = `R$ ${formatCurrency(dailyTotal)}`;
        }

        // Adicionar linha de total di√°rio
        function addDailyTotalRow(tbody, date, total) {
            const totalRow = document.createElement('tr');
            totalRow.classList.add('bg-gray-100', 'font-semibold');
            totalRow.innerHTML = `
                <td class="px-2 md:px-4 py-2" colspan="2">Total ${date}:</td>
                <td class="px-2 md:px-4 py-2">R$ ${formatCurrency(total)}</td>
                <td colspan="3"></td>
            `;
            tbody.appendChild(totalRow);
        }

        function updateMonthlySummary() {
            const monthSales = getCurrentMonthSales();
            
            // Calcular totais
            const totalSold = monthSales
                .filter(sale => sale.type === 'sale')
                .reduce((sum, sale) => sum + sale.value, 0);
                
            const totalReturns = monthSales
                .filter(sale => sale.type === 'return')
                .reduce((sum, sale) => sum + sale.value, 0);
                
            const netAmount = totalSold - totalReturns;
            
            // Obter meta do m√™s atual
            const goalKey = `${currentYear}-${currentMonth}`;
            const monthlyGoal = monthlyGoals[goalKey] ? monthlyGoals[goalKey].goal : 0;
            const workdays = monthlyGoals[goalKey] ? monthlyGoals[goalKey].workdays : 22;
            
            // Calcular valores
            const remainingGoal = Math.max(0, monthlyGoal - netAmount);
            const daysRemaining = calculateRemainingWorkdays();
            const dailyGoal = daysRemaining > 0 ? remainingGoal / daysRemaining : 0;
            
            // Calcular m√©dia necess√°ria por dia √∫til
            const daysPassed = calculatePassedWorkdays();
            const averageNeeded = monthlyGoal > 0 ? monthlyGoal / workdays : 0;
            const currentAverage = daysPassed > 0 ? netAmount / daysPassed : 0;

            // Atualizar exibi√ß√£o
            document.getElementById('total-sold').textContent = `R$ ${formatCurrency(totalSold)}`;
            document.getElementById('total-returns').textContent = `R$ ${formatCurrency(totalReturns)}`;
            document.getElementById('net-amount').textContent = `R$ ${formatCurrency(netAmount)}`;
            document.getElementById('monthly-goal-display').textContent = `R$ ${formatCurrency(monthlyGoal)}`;
            document.getElementById('daily-goal').textContent = `R$ ${formatCurrency(dailyGoal)}`;
            document.getElementById('average-needed').textContent = `R$ ${formatCurrency(averageNeeded)}`;
            
            // Adicionar cor baseada no desempenho
            const averageElement = document.getElementById('average-needed');
            if (currentAverage >= averageNeeded) {
                averageElement.classList.remove('text-indigo-600', 'text-red-600');
                averageElement.classList.add('text-green-600');
            } else {
                averageElement.classList.remove('text-indigo-600', 'text-green-600');
                averageElement.classList.add('text-red-600');
            }

            console.log('Resumo atualizado - Vendido:', totalSold, 'Meta:', monthlyGoal, 'M√©dia necess√°ria:', averageNeeded);
        }

        // ... (restante das fun√ß√µes permanecem iguais)

        // Fun√ß√µes auxiliares
        function getCurrentMonthSales() {
            if (!salesData[currentYear] || !salesData[currentYear][currentMonth]) {
                return [];
            }
            // Garantir que √© um array
            if (!Array.isArray(salesData[currentYear][currentMonth])) {
                salesData[currentYear][currentMonth] = [];
            }
            return salesData[currentYear][currentMonth];
        }

        function formatStoredDate(dateString) {
            const parts = dateString.split('-');
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function formatCurrency(value) {
            return value.toFixed(2).replace('.', ',');
        }

        // Adicionar fun√ß√£o para debug
        function debugData() {
            console.log('=== DEBUG DOS DADOS ===');
            console.log('Dispositivo:', isMobile() ? 'Mobile' : 'Desktop');
            console.log('salesData:', salesData);
            console.log('monthlyGoals:', monthlyGoals);
            console.log('monthNotes:', monthNotes);
            console.log('localStorage salesData:', localStorage.getItem('salesData'));
            console.log('localStorage monthlyGoals:', localStorage.getItem('monthlyGoals'));
            console.log('localStorage monthNotes:', localStorage.getItem('monthNotes'));
            console.log('=== FIM DEBUG ===');
        }

        // Expor fun√ß√£o de debug globalmente para testes
        window.debugData = debugData;

        console.log('Planilha de Vendas carregada com sucesso!');
        console.log('Use debugData() no console para verificar os dados');
    </script>
</body>
</html>